<!-- [esri.Basemap] Unable to find basemap definition for: sss. Try one of these: "streets", "satellite", "hybrid", "terrain", "topo", "gray", "dark-gray", "oceans", "national-geographic", "osm", "dark-gray-vector", "gray-vector", "streets-vector", "topo-vector", "streets-night-vector", "streets-relief-vector", "streets-navigation-vector" -->
<!DOCTYPE html>
<html>
<head>
	<title>IGeometry-Head</title>
	<script src='https://js.arcgis.com/4.4'></script>
	<link rel="stylesheet" type="text/css" href="https://js.arcgis.com/4.4/esri/css/main.css">
</head>
<body>
	<!-- <script > alert("test")</script> -->
	<!-- <button id="satillite">Satillite Map</button>
	<button id="streets">Streets Map</button>
	<button id="topo">Topo Maps</button> -->
	Servces: <select id="lstservices"></select> <br>
	<!-- <button id="test">satellite</button> -->
	Basemap: <select id="buttons"></select>
	<table border=1>
		<tr>
			<td valign="top">
				<div id="toc">
				  <!--  <ul>
					<li>Bread</li>
					<li>Cheese</li>
					<li>Wine</li>
					<li>Fried Chicken</li>
				   </ul> -->
				</div>
			</td>
			<td>
				<div id = 'mapview' style ='width: 700px; height: 500px'> Map goes here</div>
			</td>
		</tr>
		<tr>
			<td colspan=2><div id="pagesNums">Page numbers go here</div></td>
		</tr>
		<tr>
			<td colspan=2><div id="attributetable">ATTRIBUTE TABLE</div></td>
		</tr>
	</table>
	<script type="text/javascript">
		//let satmap;
		let streetsmap;
		//let topomap;
		let mapview;
		let maplayer;
		let Request;
		let Graphic;
		let selectedLayer;
		//let sceneview;
		const DEFAULT_BASEMAP="osm";
		const DEFAULT_MAP_SERVICE="Water_Network"
		const DEFAULT_PAGE_SIZE=50
		

		// document.getElementById("test").addEventListener("click",function(e)
		// {
		// 	//alert(e.target.textContent)
		// 	streetsmap.basemap=e.target.textContent;

		// }
		// )

		require(["esri/Map",
		"esri/views/MapView",
		"esri/views/SceneView",
		"esri/request",
		"esri/layers/MapImageLayer",
		"esri/widgets/Legend",
		"esri/widgets/Search","esri/Graphic"],function(Map,
		MapView,
		SceneView,
		esriRequest,
		MapImageLayer,
		Legend,
		Search,GraphicClass)
		{
			generateBasemaps();
			Request=esriRequest;
			Graphic=GraphicClass;

			//satmap = new Map({basemap:"satellite"})
			streetsmap=new Map({basemap:DEFAULT_BASEMAP})
			//topomap= new Map({basemap:"topo"})
			
			let viewoptions={container:"mapview",map:streetsmap,zoom:13,center:[171.24511494018407,-44.09213876558367],scale:10000}
			mapview = new MapView(viewoptions)
			//sceneview= new SceneView(viewoptions)
			// let maplayer = new MapImageLayer({url:"https://sampleserver6.arcgisonline.com/arcgis/rest/services/AGP/Census/MapServer?f=pjson"})
			// streetsmap.add(maplayer)
			// maplayer.then
			// ( function()
			// {
			// 	mapview.goTo(maplayer.fullExtent)

				
			// }
			// )
			let legend = new Legend({view:mapview})
			mapview.ui.add(legend,"bottom-left")

			let search = new Search({view:mapview})
			mapview.ui.add(search,"top-left")

			populateMapServices();

			function populateMapServices()
			{
			    let url="https://sampleserver6.arcgisonline.com/arcgis/rest/services?f=pjson"
				let options={responseType:"json"}
				Request(url,options)
				.then(response=>{
				let results = response.data
				//alert(result.folders)
				for(let i=0;i < results.services.length;i++)
					{
					let option = document.createElement("option")
				    option.textContent= results.services[i].name
				    lstservices.appendChild(option)
				    if (results.services[i].name == DEFAULT_MAP_SERVICE) option.selected=true
                    }
					//alert(results.folders[i])
				})


			}

			let mapServiceUrl= "https://sampleserver6.arcgisonline.com/arcgis/rest/services/"+DEFAULT_MAP_SERVICE+"/MapServer?f=pjson"
			maplayer=new MapImageLayer({url:mapServiceUrl})
			streetsmap.add(maplayer)
			maplayer.then
			    (function()
					   {
					   	let toc=document.getElementById("toc")
					   	toc.innerHTML=""
					   	let layerlist = document.createElement("ul")
					   	toc.appendChild(layerlist)
					   	populateLayerRecursive(maplayer,layerlist)
						mapview.goTo(maplayer.fullExtent)
					    }
			    )

			
			//getCount(9)
			let lstservices = document.getElementById("lstservices")
			lstservices.addEventListener("change",()=>
			{
				selectedLayer = lstservices.options[lstservices.selectedIndex].textContent
				alert(selectedLayer)
				let layerurl= "https://sampleserver6.arcgisonline.com/arcgis/rest/services/"+selectedLayer+"/MapServer?f=pjson"
				maplayer = new MapImageLayer({url:layerurl})
				streetsmap.removeAll()
			    streetsmap.add(maplayer)
			    //wait until the layer is loadedSSS
			    maplayer.then(buildToc)

			})
			
		}
		)
		// document.getElementById("satillite").addEventListener("click",
		// 	function()
		// 	{
		// 		// alert("Hello, you just clicked on me")
		// 		//mapview.map=map2
		// 		// if (sceneview.map == map1 )
		// 		//    sceneview.map=map2
		// 		// else
		// 		// 	sceneview.map= map1
		// 		//let lastcenter = sceneview.center
		// 		sceneview.map=satmap
		// 		//sceneview.center=lastcenter

		// 	}

		// 	)
		// document.getElementById("streets").addEventListener("click",
		// 	function()
		// 	{
		// 		//let lastcenter=sceneview.center
		// 		sceneview.map=streetsmap
		// 		//sceneview.center=lastcenter
		// 	}
		// 	)
		// document.getElementById("topo").addEventListener("click",
		// 	function()
		// 	{
		// 		//let lastcenter=sceneview.center
		// 		sceneview.map=topomap
		// 		//sceneview.center=lastcenter
		// 	}
		// 	)
		//generate a list of buttons for basemaps
		function drawPoint(x,y)
		{
			let p = {
				type: "point",
				longitude:x,
				latitude:y
			}
			let s = {
				type: "simple-marker",
				color:"red"
			}
			let graphic = new Graphic({geometry:p,symbol:s})
			mapview.graphics.add(graphic)

		}
		function drawLine(x1,y1,x2,y2)
		{

		}
		function drawPolygon(x1,y1,x2,y2,x3,y3)
		{

		}
		
		function buildToc()	
		   {
			   	let toc=document.getElementById("toc")
			   	toc.innerHTML=""
			   	let layerlist = document.createElement("ul")
			   	toc.appendChild(layerlist)
			   	populateLayerRecursive(maplayer,layerlist)
				mapview.goTo(maplayer.fullExtent)

			    }						
		function getCount(serviceID,featureCount) 
		{
			
			let queryurl="https://sampleserver6.arcgisonline.com/arcgis/rest/services/"+selectedLayer+"/MapServer/"+serviceID+"/query"
			let queryoptions={
				responseType:"json",
				query:{
					where:"1=1",
					returnCountOnly:true,
					f:"json" 
				}
			}
			//Request(queryurl,queryoptions).thenresponse=>el.textContent=response.data.count,response=>el.style.visibility="hidden")
			Request(queryurl,queryoptions).then(response=>featureCount(response.data.count),response=>featureCount(0))
			

		}

		function populateLayerRecursive(thislayer,layerlist)
		{

			let chk = document.createElement("input");
			chk.type="checkbox";
			chk.value=thislayer.id;
			chk.checked=thislayer.visible;
			chk.addEventListener("click",function(e)
			{
				//thislayer.findSublayerById(Number(e.target.value)).visible=chk.checked;
				thislayer.visible=e.target.checked;

			}
			)

			let lbl=document.createElement("label");
			lbl.textContent=thislayer.title+"    ";
			let bttn=document.createElement("button");
			bttn.layerid=thislayer.id;
			bttn.textContent="View";
			//on click, open the attribute table.
			bttn.addEventListener("click",openAttributeTable);


			//getCount(thislayer.id,bttn)
			//bttn.addEventListener("click",e => getCount(thislayer.id,bttn))

			let layeritem = document.createElement("li");
			layeritem.appendChild(chk);
			layeritem.appendChild(lbl);
			layeritem.appendChild(bttn);
			layerlist.appendChild(layeritem);

			if(thislayer.sublayers !=null &&  thislayer.sublayers.items.length > 0)
			{
				for (let i = 0 ; i < thislayer.sublayers.length; i++)
				{
					let sublayer = thislayer.sublayers.items[i]
					let newlayerlist=document.createElement("ul")
					layerlist.appendChild(newlayerlist)
					populateLayerRecursive(sublayer,newlayerlist)


				}
			}
			// for(let i = 0; i < thislayer.sublayers.length; i++)
			// 		   	{
			// 		   		//toc.removeAll()
					   		

			// 		   	}
			//let subLayer=thislayer.sublayers.items[i]

		}
		function generateBasemaps()
		{
			let basemaps=[];
			basemaps.push("satellite");
			basemaps.push("topo");
			basemaps.push("osm");
			basemaps.push("hybrid");
			basemaps.push("terrain")
			basemaps.push("dark-gray")
			basemaps.push("oceans")
			basemaps.push("streets-night-vector")
			basemaps.push("streets")
			//let changeBasemap = function(e){streetsmap.basemap=e.target.textContent}
			let buttonsSel= document.getElementById("buttons")
			let changeBasemap=e=>streetsmap.basemap=buttonsSel.options[buttonsSel.selectedIndex].textContent
			for(let i=0;i<basemaps.length;i++)
			{
				// let button=document.createElement("button")
				// button.id=basemaps[i]
				// button.textContent=basemaps[i]
				// button.addEventListener("click",changeBasemap)
				// document.getElementById("buttons").appendChild(button)
				let option=document.createElement("option")
				option.id=basemaps[i]
				option.textContent=basemaps[i]
				buttonsSel.appendChild(option)
				if (basemaps[i]==DEFAULT_BASEMAP) option.selected=true
			}
			buttonsSel.addEventListener("change",changeBasemap)

		}
		let buttons=[];
		function resetButtonCol()
		{
			// let pageNums=document.getElementById("pagesNums")
			// let buttons=pageNums.children
			// buttons.forEach(b=>{
			// 	b.style.color="black"
			// })
			// for (let i=0;i<buttons.length;i++)
			// {
			// 	buttons[i].style.color="black"
			// }
			buttons.forEach(b=>{
				b.style.color="black"
			})


		}
		function populatePages(featureCount,layerID)
		{
			let pageCount=Math.ceil(featureCount/DEFAULT_PAGE_SIZE)
			alert(pageCount)
			let pageNums=document.getElementById("pagesNums")
			pageNums.innerHTML=""
			for (let i=0;i<pageCount;i++)
			{
				let button=document.createElement("button")
				button.textContent=i+1
				buttons.push(button)
				button.addEventListener("click",function(e){
					resetButtonCol()
					e.target.style.color="red"
					populateAttributeTable(layerID,featureCount,button.textContent)
				})
				pageNums.appendChild(button)
				

			}

		}
		function openAttributeTable(e)
		{
			let layerID=e.target.layerid;
			let featureCount=0;
			getCount(layerID,c =>{
				featureCount=c;
				populatePages(featureCount,layerID);
				populateAttributeTable(layerID,featureCount,1);

			});
			

		}

		function populateAttributeTable(layerID,featureCount,pageNum)
		{
			
			//alert(featureCount);

			//alert("calling attribute table for layer" + e.target.layerid)
			let queryurl="https://sampleserver6.arcgisonline.com/arcgis/rest/services/"+selectedLayer+"/MapServer/"+layerID+"/query";
			//alert(queryurl);
			let attributeTable=document.getElementById("attributetable");
			attributeTable.innerHTML=""
			//alert(attributeTable.id);

			let queryoptions={
				responseType:"json",
				query:{
					where:"1=1",
					outFields:"*",
					resultOffset:(pageNum-1)*DEFAULT_PAGE_SIZE+1,
					resultRecordCount:DEFAULT_PAGE_SIZE,
					f:"json"
				}
			}
			Request(queryurl,queryoptions).then(response=>
			{
				//alert(response.data.features.length);
				let table=document.createElement("table");
				table.border=1.5;
				let header = document.createElement("tr");
				table.appendChild(header);
				//populate the fields/ columns
				for (let i = 0; i < response.data.fields.length; i++)
				{
					//alert(response.data.fields[i].name)
					let col=document.createElement("th");
					col.textContent=response.data.fields[i].alias;
					header.appendChild(col);
				}
				

				//loop through all features
				for (let j = 0;j < response.data.features.length; j++)
				{
					let feature= response.data.features[j];
					let row = document.createElement("tr");
					table.appendChild(row);
					for (let i = 0; i <response.data.fields.length; i++)
					{
						let field=response.data.fields[i]
						let col=document.createElement("td");
						if (field.type ==  "esriFieldTypeDate")
						{
							let date = new Date(feature.attributes[field.name]);
							col.textContent=date;
							row.appendChild(col);

						}
						else
						{
						   col.textContent=feature.attributes[field.name];
						   row.appendChild(col);

						}
						
					}
				}
				attributeTable.appendChild(table)


			}
			)

		}

	</script>


</body>
</html>